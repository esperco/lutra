#! /bin/sh
set -e

# Normally we are in the setup/ subdirectory of the project
ROOT=$(pwd)
mkdir -p "$ROOT"/bin
mkdir -p "$ROOT"/js
mkdir -p "$ROOT"/ts

# Get archives from our github repository, then unpack them.
# Prepare two versions of each Javascript file:
# - versionless source, e.g. jquery.js
# - versionless minified code, e.g. jquery.min.js

# Install a source Javascript file, minify it and install the minified version
# as well.
# The 'cat' argument must be a program that reads the input js from stdin
# and writes the js output on stdout. This gives a chance to perform
# some wrapping (e.g. jquery-freeze).
install_js() {
    name="$1"
    src="$2"
    cat="$3"
    if [ -z "$cat" ]; then
        cat=cat
    fi
    echo "Installing $name"
    "$cat" < "$src" > "$ROOT"/js/"$name".js
}

install_ts() {
    name="$1"
    echo "Importing $name"
    cp -a "$name" "$ROOT"/ts/"$name"
}

# TypeScript type definitions for some of the JavaScript libraries we're using
cd "$ROOT"
if [ ! -d DefinitelyTyped ]; then
    git clone git@github.com:esperco/DefinitelyTyped.git
fi

cd "$ROOT"/DefinitelyTyped
git checkout master
git pull --ff-only origin master

install_ts jquery
install_ts jqueryui
install_ts chrome
install_ts cryptojs

cd "$ROOT"
if [ ! -d gmail.js ]; then
    git clone git@github.com:timeco/gmail.js.git
fi

cd "$ROOT"/gmail.js
git checkout master
git pull --ff-only origin master

install_js gmail src/gmail.js

cd "$ROOT"
if [ ! -d mink-libs ]; then
    git clone git@github.com:esperco/mink-libs.git
fi

cd "$ROOT"/mink-libs
git checkout master
git pull --ff-only origin master

install_js sha1 sha1.js

# jQuery
install_js jquery jquery-2.1.0.js
# full jQuery UI
unzip -o jquery-ui-1.11.0.custom.zip
install_js jqueryui jquery-ui-1.11.0.custom/jquery-ui.js "$ROOT"/jquery-freeze

# Bootstrap
rm -rf bootstrap dist
unzip bootstrap-3.0.2-dist.zip
mv dist bootstrap
install_js bootstrap bootstrap/js/bootstrap.js "$ROOT"/jquery-freeze

# jsTimezoneDetect (jstz)
install_js jstz jstz-2013-04-01-f9e3e30e.js

# retina.js
install_js retina retina-1.3.0.js

# Google sign-in button
(cd google-buttons && unzip -o gplus-assets.zip)


# oblivion preprocessor, requires ocaml.
# We install it manually so we don't depend on an opam setup
cd "$ROOT"
if [ ! -d oblivion ]; then
    git clone git@github.com:esperco/oblivion.git
fi
cd oblivion
git checkout master
git pull --ff-only origin master
make
make PREFIX="$ROOT" install

# Don't want my Javascript files to be executable for no reason
chmod a-x "$ROOT"/js/*.js
