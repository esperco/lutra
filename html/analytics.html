<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Esper</title>
    <script type="text/javascript">
      /*
        Purpose of this page is to enable cross-domain analytics tracking of
        anonymous users. Mixpanel and Segment may have cookies or other
        domain-specific variables stored that link the current logged in
        user to an anonymous or distinct id, so we need to open a page under
        the esper.com domain to properly track.

        Following query params are available:

          * writeKey - Segment write key to use
          * page - Name of page to track using analytics.page
          * category - Optional page category
          * event - Event to track using analytics.track. Mutually exclusive
            with page param.
          * properties - JSON-encoded dict of properties for event or page call

        Sample usage

          esper.com/analytics?writeKey=MY_WRITE_KEY&event=Signed%20Up&
          properties=%7B%22plan%22%3A%22Startup%22%2C%22source%22%3A%22
          Analytics%20Academy%22%7D

        When complete, this page will call window.post to send a message
        acknowledging completion.
      */

      // Load Analytics.js
      /* jshint ignore:start */
      !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
      }}();
      /* jshint ignore:end */

      /* jshint browser: true */
      /* global analytics: true */
      (function() {
        "use strict";

        function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(window.location.search);
          return (results === null ? "" :
            decodeURIComponent(results[1].replace(/\+/g, " ")));
        }

        analytics.load(getParameterByName("writeKey"));

        var page = getParameterByName("page");
        var category = getParameterByName("category");
        var ev = getParameterByName("event");
        var props = getParameterByName("properties");
        props = (props && JSON.parse(props)) || {};

        // Callback to post back to parent frame that analytics call completed
        // and that ifrae can be completed
        var cb = function() {
          var win = window.opener || window.parent;
          win.postMessage({
            sender: "Esper Analytics",
            type: "Analytics Sent"
          }, "*");
        };

        console.info(ev);
        console.info(page);
        console.info(category);
        console.info(props);
        if (page) {
          if (category) {
            analytics.page(category, page, props, cb);
          }
          analytics.page(page, props, cb);
        }

        else if (ev) {
          analytics.track(ev, props, cb);

          // To filter out possible weirdness with sites -- page call should
          // automatically add this
          props.referrer = document.referrer;
        }
      })();
    </script>
  </head>

  <body>
  </body>
</html>
